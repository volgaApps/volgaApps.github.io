<!doctype html>
<html>

<head>
  <title>CrossRoadPDD</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta id="gameViewport" name="viewport" content="width=device-width initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link href="styles.css" rel="stylesheet" type="text/css">
  <!-- Yandex Games SDK -->
  <script src="https://yandex.ru/games/sdk/v2"></script>
  <script>
    YaGames
      .init({
        screen: {
          fullscreen: false,
          orientation: {
            value: 'portrait',
          }
        },
        adv: {
          onAdvClose: wasShown => {
            console.info('adv closed!');
          }
        }
      })
      .then(ysdk => {
        sdk = ysdk;
        ysdk.adv.showFullscreenAdv();
      });
  </script>

  <script>
    function showYndxAd() {
      console.log("start showYndxAd function, version = 2");
      sdk.adv.showFullscreenAdv({ callbacks: {} });
    }
  </script>

  <script>
    function getYndxPayload() {
      console.log("start getYndxPayload");
      if (typeof (sdk) == "undefined")
        return "undefined";
      else return "" + sdk.environment.payload;
    }

    function setYndxPayloadEmpty() {
      sdk.environment.payload = "undefined";
    }

  </script>

  <script>
    function showStickyBannerYndx() {
      sdk.adv.getBannerAdvStatus().then(({ stickyAdvIsShowing, reason }) => {
        if (stickyAdvIsShowing) {
          console.log("sticky yndxBanner is showing");
        } else if (reason) {
          console.log("sticky yndxBanner isn't showing")
          console.log(reason);
        } else {
          console.log("show sticky yndxBanner")
          sdk.adv.showBannerAdv();
        }
      })
    }
  </script>

  <script>
    function hideStickyBannerYndx() {
      console.log("hideStickyBannerYndx() in hide");
      sdk.adv.hideBannerAdv();
    }
  </script>

  <script>
    function appLaunchFromVK() {
      return false;
    }
  </script>

  <script>
    function showHtmlRewardedVideoAd() {
      sdk.adv.showRewardedVideo({
        callbacks: {
          onOpen: () => {
            console.log('Video ad open.');
          },
          onRewarded: () => {
            console.log('Rewarded!');
            window.setOnRewarded(); // оповестить  HtmlLauncher о получении пользователем вознаграждения
          },
          onClose: () => {
            console.log('Video ad closed.');
          },
          onError: (e) => {
            console.log('Error while open video ad:', e);
            window.setRewardedOnError(); // оповестить об ошибке в загрузке объявления
          }
        }
      })
    }
  </script>
</head>

<body>
  <div align="center" id="embed-html"></div>
  <script type="text/javascript" src="html/html.nocache.js"></script>
</body>

<script>
  function handleMouseDown(evt) {
    evt.preventDefault();
    evt.stopPropagation();
    window.focus();
  }

  function handleMouseUp(evt) {
    evt.preventDefault();
    evt.stopPropagation();
  }
  document.getElementById('embed-html').addEventListener('mousedown', handleMouseDown, false);
  document.getElementById('embed-html').addEventListener('mouseup', handleMouseUp, false);
</script>

<script>
  const audioCtx = new AudioContext();
  let alarmSound;
  let bicycleSound;
  let carAccidentSound;
  let carMovingSound;
  let clickSound;
  let stepsSound;
  let tramSound;

  function getData(source, soundsName) {
    console.log("getDatas()");
    source = new AudioBufferSourceNode(audioCtx);
    request = new XMLHttpRequest();
    request.open("GET", soundsName, true);
    request.responseType = "arraybuffer";
    request.onload = () => {
      let audioData = request.response;
      audioCtx.decodeAudioData(
        audioData,
        (buffer) => {
          source.buffer = buffer;
          source.connect(audioCtx.destination);
        },
        (e) => {
          `Error with decoding audio data ${e.error}`;
        }
      );
    };
    request.send();
    return source;
  }

  function pauseWebAudio() {
    // console.log('pauseMusicTheme()');
    audioCtx.suspend();
  }

  function resumeWebAudio() {
    console.log('audioCtx in resumeWebAudio = ' + audioCtx);
    console.log('audioCtx.state in resumeWebAudio = ' + audioCtx.state);
    if (audioCtx === 'undefined') {
      audioCtx = new AudioContext();
    } else {
      audioCtx.resume();
    }
  }

  function setVolume(volume) {
    // gainNode.gain.value = volume;
  }

  function stopMusicTheme() {
    // console.log('stopMusicTheme()')

  }

  function playSound(source, soundsName) {
    source = getData(source, soundsName);
    source.start(0);
  }


  function playClickSound() {
    playSound(clickSound, "sounds/click.mp3");
  }

  function playAlarmSound() {
    // alarmSound = fetchAndPlay(alarmSound, 'sounds/alarm.mp3', true);
    // playSound(alarmSound, "sounds/alarm.mp3");
    const songDataPromise = fetchSong("sounds/alarm.mp3");   // Promise {<pending>}
  songDataPromise.then((audioBuffer) => {
    alarmSound = play(audioBuffer, alarmSound, true);
    console.log("audioBuffer = " + audioBuffer);                    // AudioBuffer {}
    console.log("audioBuffer.getChannelData(0) = " + audioBuffer.getChannelData(0));  // Float32Array []
  });
  }

  function play(audioBuffer, source, loop) {
    source = audioCtx.createBufferSource();
    source.buffer = audioBuffer;
    source.connect(audioCtx.destination);
    source.loop = loop;
    source.start(0);
    return source;
  }

  async function fetchAndPlay(source, url, loop) {
    audioCtx.decodeAudioData(
      await fetch(url)
        .then(r => r.arrayBuffer()),
      decoded => play(decoded, source, loop)
    );
  }

  const fetchSong = async (path) => {
    const xhr = await fetch(path);
    const arrayBuffer = await xhr.arrayBuffer();
    return audioCtx.decodeAudioData(arrayBuffer);
  };

  const songDataPromise = fetchSong("sounds/alarm.mp3");   // Promise {<pending>}
  songDataPromise.then((audioBuffer) => {
    // play(audioBuffer, alarmSound, true);
    console.log(audioBuffer);                    // AudioBuffer {}
    console.log(audioBuffer.getChannelData(0));  // Float32Array []
  });

  function stopAlarmSound() {
    alarmSound.stop(0);
  }

  function playBicycleSound() {
    playSound(bicycleSound, "sounds/bicycle.mp3");
  }

  function playCarAccidentSound() {
    playSound(carAccidentSound, "sounds/car_accident.mp3");
  }

  function playCarMovingSound() {
    playSound(carMovingSound, "sounds/car_moving.mp3");
  }

  function playStepsSound() {
    playSound(stepsSound, "sounds/steps.mp3");
  }

  function playTramSound() {
    playSound(tramSound, "sounds/tram_sound.mp3");
  }

</script>

</html>