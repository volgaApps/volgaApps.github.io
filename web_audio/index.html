<!doctype html>
<html>

<head>
  <title>CrossRoadPDD</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta id="gameViewport" name="viewport" content="width=device-width initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- Yandex Games SDK -->
  <script src="https://yandex.ru/games/sdk/v2"></script>
  <script>
    YaGames
      .init({
        screen: {
          fullscreen: false,
          orientation: {
            value: 'portrait',
          }
        },
        adv: {
          onAdvClose: wasShown => {
            console.info('adv closed!');
          }
        }
      })
      .then(ysdk => {
        sdk = ysdk;
        ysdk.adv.showFullscreenAdv();
      });
  </script>

  <script>
    function showYndxAd() {
      console.log("start showYndxAd function, version = 2");
      sdk.adv.showFullscreenAdv({ callbacks: {} });
    }
  </script>

  <script>
    function getYndxPayload() {
      console.log("start getYndxPayload");
      if (typeof (sdk) == "undefined")
        return "undefined";
      else return "" + sdk.environment.payload;
    }

    function setYndxPayloadEmpty() {
      sdk.environment.payload = "undefined";
    }

  </script>

  <script>
    function showStickyBannerYndx() {
      sdk.adv.getBannerAdvStatus().then(({ stickyAdvIsShowing, reason }) => {
        if (stickyAdvIsShowing) {
          console.log("sticky yndxBanner is showing");
        } else if (reason) {
          console.log("sticky yndxBanner isn't showing")
          console.log(reason);
        } else {
          console.log("show sticky yndxBanner")
          sdk.adv.showBannerAdv();
        }
      })
    }
  </script>

  <script>
    function hideStickyBannerYndx() {
      console.log("hideStickyBannerYndx() in hide");
      sdk.adv.hideBannerAdv();
    }
  </script>

  <script>
    function appLaunchFromVK() {
      return false;
    }
  </script>

  <script>
    function showHtmlRewardedVideoAd() {
      sdk.adv.showRewardedVideo({
        callbacks: {
          onOpen: () => {
            console.log('Video ad open.');
          },
          onRewarded: () => {
            console.log('Rewarded!');
            window.setOnRewarded(); // оповестить  HtmlLauncher о получении пользователем вознаграждения
          },
          onClose: () => {
            console.log('Video ad closed.');
          },
          onError: (e) => {
            console.log('Error while open video ad:', e);
            window.setRewardedOnError(); // оповестить об ошибке в загрузке объявления
          }
        }
      })
    }
  </script>
</head>

<body>
  <div align="center" id="embed-html"></div>
  <script type="text/javascript" src="html/html.nocache.js"></script>
</body>

<script>
  function handleMouseDown(evt) {
    evt.preventDefault();
    evt.stopPropagation();
    window.focus();
  }

  function handleMouseUp(evt) {
    evt.preventDefault();
    evt.stopPropagation();
  }
  document.getElementById('embed-html').addEventListener('mousedown', handleMouseDown, false);
  document.getElementById('embed-html').addEventListener('mouseup', handleMouseUp, false);
</script>

<script>

  let alarmSound;
  let bicycleSound;
  let carAccidentSound;
  let carMovingSound;
  let clickSound;
  let stepsSound;
  let tramSound;

  const audioCtx = new AudioContext();
  unlockAudioContext(audioCtx);

  function unlockAudioContext(audioCtx) {
    if (audioCtx.state !== 'suspended') return;
    const b = document.body;
    const events = ['touchstart', 'touchend', 'mousedown', 'keydown'];
    events.forEach(e => b.addEventListener(e, unlock, false));
    function unlock() { audioCtx.resume().then(clean); }
    function clean() { events.forEach(e => b.removeEventListener(e, unlock)); }
  }
  
  console.log('audioCtx.state = ' + audioCtx.state);
  // функция, декодирующая звук асинхронно
  const fetchSong = async (path) => {
    const xhr = await fetch(path);
    const arrayBuffer = await xhr.arrayBuffer();
    return audioCtx.decodeAudioData(arrayBuffer);
  };

  function play(audioBuffer, source, loop) {
    source = audioCtx.createBufferSource();
    source.buffer = audioBuffer;
    source.connect(audioCtx.destination);
    source.loop = loop;
    source.start(0);
    return source;
  }

  function pauseWebAudio() {
    // console.log('pauseMusicTheme()');
    audioCtx.suspend();
  }

  function resumeWebAudio() {
    console.log('audioCtx in resumeWebAudio = ' + audioCtx);
    console.log('audioCtx.state in resumeWebAudio = ' + audioCtx.state);
    if (audioCtx === 'undefined') {
      audioCtx = new AudioContext();
    } else {
      audioCtx.resume();
    }
  }

  function setVolume(volume) {
    // gainNode.gain.value = volume;
  }

  function stopMusicTheme() {
    // console.log('stopMusicTheme()')

  }

  function playClickSound() {
    const songDataPromise = fetchSong("sounds/click.mp3");   // Promise {<pending>}
    songDataPromise.then((audioBuffer) => {
      clickSound = play(audioBuffer, alarmSound, false);
    });
  }

  function playAlarmSound() {
    const songDataPromise = fetchSong("sounds/alarm.mp3");   // Promise {<pending>}
    songDataPromise.then((audioBuffer) => {
      alarmSound = play(audioBuffer, alarmSound, true);
    });
  }

  function stopAlarmSound() {
    alarmSound.stop(0);
  }

  function playBicycleSound() {
    const songDataPromise = fetchSong("sounds/bicycle.mp3");   // Promise {<pending>}
    songDataPromise.then((audioBuffer) => {
      bicycleSound = play(audioBuffer, alarmSound, false);
    });
  }

  function playCarAccidentSound() {
    const songDataPromise = fetchSong("sounds/car_accident.mp3");   // Promise {<pending>}
    songDataPromise.then((audioBuffer) => {
      carAccidentSound = play(audioBuffer, alarmSound, false);
    });
  }

  function playCarMovingSound() {
    const songDataPromise = fetchSong("sounds/car_moving.mp3");   // Promise {<pending>}
    songDataPromise.then((audioBuffer) => {
      carMovingSound = play(audioBuffer, alarmSound, false);
    });
  }

  function playStepsSound() {
    const songDataPromise = fetchSong("sounds/steps.mp3");   // Promise {<pending>}
    songDataPromise.then((audioBuffer) => {
      stepsSound = play(audioBuffer, alarmSound, false);
    });
  }

  function playTramSound() {
    const songDataPromise = fetchSong("sounds/tram_sound.mp3");   // Promise {<pending>}
    songDataPromise.then((audioBuffer) => {
      tramSound = play(audioBuffer, alarmSound, false);
    });
  }

</script>

</html>